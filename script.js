const diceData = {
  d2: [
    {name: "Ja", url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/Ja.png?v=1751446863846"},
    {name: "Nein", url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/Nein.png?v=1751446865246"}
  ],
  d6: [
    {num: 1, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d6.png?v=1751448970694"},
    {num: 2, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d6 (5).png?v=1751448976383"},
    {num: 3, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d6 (2).png?v=1751448973199"},
    {num: 4, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d6 (3).png?v=1751448973732"},
    {num: 5, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d6 (4).png?v=1751448974183"},
    {num: 6, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d6 (1).png?v=1751448973952"},
  ],
  d10: [
    {num: 1, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/1.png?v=1751447027181"},
    {num: 2, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/2.png?v=1751447029352"},
    {num: 3, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/3.png?v=1751447034345"},
    {num: 4, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/4.png?v=1751447043367"},
    {num: 5, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/5.png?v=1751447047402"},
    {num: 6, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/6.png?v=1751447062201"},
    {num: 7, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/7.png?v=1751445758040"},
    {num: 8, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/8.png?v=1751445759007"},
    {num: 9, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/9.png?v=1751445759524"},
    {num: 10,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/10.png?v=1751445761843"}
  ],
  d20: [
    {num: 1, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20.png?v=1751447283229"},
    {num: 2, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (9).png?v=1751447286663"},
    {num: 3, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (2).png?v=1751447298836"},
    {num: 4, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (4).png?v=1751447290363"},
    {num: 5, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (5).png?v=1751447295672"},
    {num: 6, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (6).png?v=1751447298429"},
    {num: 7, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (7).png?v=1751447300842"},
    {num: 8, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (1).png?v=1751447303643"},
    {num: 9, url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (8).png?v=1751447305864"},
    {num: 10,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/d20 (3).png?v=1751447282460"},
    {num: 11,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/11.png?v=1751444184733"},
    {num: 12,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/12.png?v=1751444185268"},
    {num: 13,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/13.png?v=1751444185783"},
    {num: 14,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/14.png?v=1751444186307"},
    {num: 15,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/15.png?v=1751444186786"},
    {num: 16,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/16.png?v=1751444170331"},
    {num: 17,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/17.png?v=1751444175343"},
    {num: 18,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/18.png?v=1751444175860"},
    {num: 19,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/19.png?v=1751444176346"},
    {num: 20,url: "https://cdn.glitch.global/c8aaad5e-0231-4972-83e1-a4a50eee8024/20.png?v=1751444174885"},
  ]
};

const usernameInput = document.getElementById('username');
const diceTypeSelect = document.getElementById('dice-type');
const rollBtn = document.getElementById('roll');
const currentResultImg = document.getElementById('current-result');
const checkResultEl = document.getElementById('check-result');
const historyList = document.getElementById('history');
const attrValueInput = document.getElementById('attribute-value');
const bonusValueInput = document.getElementById('bonus-value');
const difficultyValueInput = document.getElementById('difficulty-value');

let history = [];

// Initialize Socket.IO connection
const socket = io();
let isConnected = false;

// Load saved username
const savedUsername = localStorage.getItem('username');
if (savedUsername) {
  usernameInput.value = savedUsername;
}

// Save username when it changes and notify server
usernameInput.addEventListener('input', () => {
  localStorage.setItem('username', usernameInput.value);
  if (isConnected && usernameInput.value.trim()) {
    socket.emit('player-join', usernameInput.value.trim());
  }
});

// Socket event listeners
socket.on('connect', () => {
  isConnected = true;
  console.log('Connected to multiplayer server');
  
  // Join with current username
  const username = usernameInput.value.trim() || 'Unbekannt';
  socket.emit('player-join', username);
});

socket.on('disconnect', () => {
  isConnected = false;
  console.log('Disconnected from server');
});

socket.on('players-update', (players) => {
  updatePlayersList(players);
});

socket.on('recent-rolls', (rolls) => {
  history = rolls;
  renderHistory();
});

socket.on('new-roll', (rollInfo) => {
  // Add new roll to history
  history.unshift(rollInfo);
  if (history.length > 8) history.pop();
  renderHistory();
  
  // Show notification for other players' rolls
  if (rollInfo.socketId !== socket.id) {
    showRollNotification(rollInfo);
  }
});

function saveHistory() {
  localStorage.setItem('diceHistory', JSON.stringify(history));
}

function renderHistory() {
  historyList.innerHTML = '';
  history.forEach(item => {
    const li = document.createElement('li');
    const username = item.username || 'Unbekannt';
    const status = item.success !== undefined ? (item.success ? 'Geschafft' : 'Nicht geschafft') : '';
    const statusDisplay = status ?  - ${status} : '';
    li.innerHTML = <strong>${username}</strong> - ${item.diceType}: ${item.result}${statusDisplay};
    
    // Add color coding for success/failure
    if (item.success === true) {
      li.style.background = '#d4edda';
      li.style.color = '#267326';
    } else if (item.success === false) {
      li.style.background = '#f8d7da';
      li.style.color = '#a13b3b';
    }
    
    historyList.appendChild(li);
  });
}

function rollDice() {
  const diceType = diceTypeSelect.value;
  const diceArray = diceData[diceType];

  // Roll: Random Index from dice array
  const rollIndex = Math.floor(Math.random() * diceArray.length);
  const rolled = diceArray[rollIndex];

  currentResultImg.src = rolled.url;
  currentResultImg.alt = W√ºrfelergebnis: ${rolled.name || rolled.num};

  // Berechnung: Attribut + Bonus + W√ºrfelergebnis (als Zahl)
  const attributeValue = Number(attrValueInput.value) || 0;
  const bonusValue = Number(bonusValueInput.value) || 0;
  let diceRollValue = 0;

  if(diceType === 'd2') {
    // d2 ist Ja/Nein, wir nehmen f√ºr Erfolg 'Ja' als 1, 'Nein' als 0
    diceRollValue = rolled.name === "Ja" ? 1 : 0;
  } else {
    diceRollValue = rolled.num || 0;
  }

  const difficultyValue = Number(difficultyValueInput.value) || 0;
  const totalValue = attributeValue + bonusValue + diceRollValue;

  if(totalValue >= difficultyValue) {
    checkResultEl.textContent = "Geschafft";
    checkResultEl.style.color = "#267326"; // dunkles gr√ºn
  } else {
    checkResultEl.textContent = "Nicht geschafft";
    checkResultEl.style.color = "#a13b3b"; // dunkles rot
  }

  // Get username for history
  const username = usernameInput.value.trim() || 'Unbekannt';
  
  // Determine success status for history
  const success = totalValue >= difficultyValue;
  
  // Send roll to server for multiplayer sync
  if (isConnected) {
    socket.emit('dice-roll', {
      diceType: diceType,
      result: diceRollValue,
      success: success
    });
  } else {
    // Fallback to local storage if not connected
    history.unshift({ 
      diceType, 
      result: diceRollValue, 
      username: username,
      timestamp: new Date().toLocaleTimeString(),
      success: success
    });
    if(history.length > 8) history.pop();
    renderHistory();
  }
}

// Helper functions for multiplayer
function updatePlayersList(players) {
  const playersListEl = document.getElementById('players-list');
  if (!playersListEl) return;
  
  playersListEl.innerHTML = '';
  players.forEach(player => {
    const playerEl = document.createElement('span');
    playerEl.textContent = player;
    playerEl.style.cssText = 
      background: #e9ddff; 
      padding: 0.3rem 0.6rem; 
      border-radius: 8px; 
      margin: 0.2rem; 
      display: inline-block;
      font-size: 0.9rem;
      color: #6a4e95;
    ;
    playersListEl.appendChild(playerEl);
  });
}

function showRollNotification(rollInfo) {
  const statusText = rollInfo.success ? 'Geschafft' : 'Nicht geschafft';
  const emoji = rollInfo.success ? '‚úÖ' : '‚ùå';
  
  // You could add a toast notification here
  console.log(üé≤ ${rollInfo.username} rolled ${rollInfo.diceType}: ${rollInfo.result} - ${statusText} ${emoji});
}

rollBtn.addEventListener('click', rollDice);

renderHistory();
